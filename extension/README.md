# SendSafe Chrome Extension

This is the Chrome extension component of SendSafe that detects AI-generated copy-paste artifacts in Gmail.

## üìÅ Project Structure

```
extension/
‚îú‚îÄ‚îÄ manifest.json           # Extension configuration (Manifest V3)
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ config.ts          # Extension settings (backend URL, timeouts, etc.)
‚îÇ   ‚îú‚îÄ‚îÄ contentScript.ts   # Runs in Gmail, detects paste events
‚îÇ   ‚îî‚îÄ‚îÄ background.ts      # Service worker, calls backend API
‚îú‚îÄ‚îÄ dist/                  # Compiled JavaScript (generated by TypeScript)
‚îú‚îÄ‚îÄ assets/
‚îÇ   ‚îî‚îÄ‚îÄ icons/            # Extension icons (16x16, 48x48, 128x128)
‚îú‚îÄ‚îÄ package.json          # Node.js dependencies
‚îú‚îÄ‚îÄ tsconfig.json         # TypeScript configuration
‚îî‚îÄ‚îÄ README.md            # This file
```

## üöÄ How to Install for Local Testing

### Step 1: Install Dependencies

```bash
cd extension
npm install
```

### Step 2: Configure the Extension

Edit `src/config.ts` and update:

```typescript
api: {
  url: 'http://localhost:3000/api/check-ai-traces',  // Your backend URL
},
auth: {
  sharedSecret: 'your-shared-secret-here',  // Must match backend secret
}
```

### Step 3: Build the Extension

```bash
npm run build
```

This compiles TypeScript files in `src/` to JavaScript in `dist/`.

### Step 4: Load in Chrome

1. Open Chrome and go to `chrome://extensions`
2. Enable "Developer mode" (toggle in top right)
3. Click "Load unpacked"
4. Select the `extension/` folder (not the `dist/` folder)
5. The extension should now appear in your extensions list

### Step 5: Test in Gmail

1. Go to [Gmail](https://mail.google.com)
2. Open Chrome DevTools (F12)
3. Look for "SendSafe:" messages in the console
4. Compose a new email
5. Paste some text with AI artifacts (e.g., "[Your Name]" or "Sure, here's a draft:")
6. You should see a notification if AI traces are detected

## üîß Development Workflow

### Watch Mode

For active development, use watch mode to automatically recompile on changes:

```bash
npm run watch
```

Then, after making changes:
1. Save your TypeScript files
2. Go to `chrome://extensions`
3. Click the refresh icon on the SendSafe extension
4. Reload Gmail to test changes

### Debugging

**Content Script (runs in Gmail):**
1. Open Gmail
2. Open DevTools (F12)
3. Look for "SendSafe:" messages in Console tab
4. Check if compose boxes are detected
5. Check if paste events are captured

**Background Script (service worker):**
1. Go to `chrome://extensions`
2. Find SendSafe extension
3. Click "Service worker" link
4. A DevTools window opens showing background script logs
5. Look for API calls and responses

### Common Issues

**"SendSafe: Backend URL not configured"**
- Update `src/config.ts` with your backend URL
- Rebuild with `npm run build`
- Reload extension

**"SendSafe: Shared secret not configured"**
- Update `src/config.ts` with your shared secret
- Must match `SENDSAFE_SHARED_SECRET` on backend
- Rebuild and reload

**No compose boxes found:**
- Gmail's HTML structure may have changed
- Check console for selector errors
- Update `config.gmail.composeSelectors` if needed

**Paste not detected:**
- Check if paste listener is attached (console logs)
- Try different compose boxes (reply, forward, pop-out)
- Check for JavaScript errors in console

## üìù File Descriptions

### manifest.json
Chrome extension configuration file. Defines:
- Extension name, version, description
- Permissions (notifications, Gmail access)
- Content scripts (what runs in Gmail)
- Background service worker
- Icons

### src/config.ts
Centralized configuration for the extension:
- Backend API URL
- Authentication (shared secret)
- Text limits (min/max length)
- Rate limiting settings
- Gmail selectors
- Notification settings

### src/contentScript.ts
Runs inside Gmail pages. Responsibilities:
- Find Gmail compose boxes (main, reply, forward, pop-out)
- Watch for new compose boxes (Gmail creates them dynamically)
- Listen for paste events
- Extract pasted text
- Validate and truncate text
- Send to background script for analysis

### src/background.ts
Background service worker. Responsibilities:
- Receive messages from content script
- Call backend API with pasted text
- Handle API responses and errors
- Show Chrome notifications
- Manage timeouts and retries

## üîí Security Notes

### Shared Secret Visibility
The shared secret in `config.ts` is **visible to users** who inspect the extension code. This is an MVP compromise for simplicity.

**For production:**
- Implement user authentication (accounts, login)
- Issue unique API keys per user
- Use OAuth or JWT tokens
- Never rely on client-side secrets

### HTTPS Required
- Production backend must use HTTPS
- Chrome enforces secure connections for extensions
- Local development can use HTTP

### Privacy
- Extension sends pasted text to backend for analysis
- Backend does not store the text (per privacy policy)
- No personal data is collected
- Users should be informed via privacy policy

## üß™ Testing Checklist

Before submitting or deploying:

- [ ] Extension loads without errors
- [ ] Compose boxes are detected in Gmail
- [ ] Paste events are captured
- [ ] Messages are sent to background script
- [ ] Backend API is called successfully
- [ ] Notifications appear for AI-detected content
- [ ] No notification for clean content
- [ ] Error notifications work (test with backend down)
- [ ] Rate limiting works (paste many times quickly)
- [ ] Works in main compose window
- [ ] Works in reply boxes
- [ ] Works in forward boxes
- [ ] Works in pop-out compose window

## üì¶ Building for Production

### Step 1: Update Configuration
```typescript
// src/config.ts
api: {
  url: 'https://your-domain.vercel.app/api/check-ai-traces',
},
auth: {
  sharedSecret: 'your-production-secret',
}
```

### Step 2: Build
```bash
npm run build
```

### Step 3: Create Icons
Create three icon files in `assets/icons/`:
- `icon-16.png` (16x16) - Toolbar
- `icon-48.png` (48x48) - Extension management
- `icon-128.png` (128x128) - Chrome Web Store

### Step 4: Test Production Build
Load the extension in Chrome and test with production backend.

### Step 5: Package for Chrome Web Store
1. Zip the entire `extension/` folder
2. Make sure to include:
   - manifest.json
   - dist/ folder (compiled code)
   - assets/ folder (icons)
3. Do NOT include:
   - node_modules/
   - src/ folder (source code is optional)
   - .git/ folder

## üêõ Troubleshooting

### TypeScript Errors
```bash
npm run build
```
Check the output for type errors and fix them.

### Extension Won't Load
- Check `manifest.json` for syntax errors
- Verify all files referenced in manifest exist
- Check Chrome DevTools for error messages

### API Calls Failing
- Check backend is running
- Verify backend URL in config.ts
- Check shared secret matches backend
- Look at Network tab in DevTools
- Check CORS headers on backend

### Notifications Not Showing
- Check "notifications" permission in manifest
- Verify Chrome allows notifications (system settings)
- Check background script console for errors
- Test with `chrome.notifications.create()` directly

## üìö Resources

- [Chrome Extension Documentation](https://developer.chrome.com/docs/extensions/)
- [Manifest V3 Migration Guide](https://developer.chrome.com/docs/extensions/mv3/intro/)
- [Chrome Notifications API](https://developer.chrome.com/docs/extensions/reference/notifications/)
- [Content Scripts Guide](https://developer.chrome.com/docs/extensions/mv3/content_scripts/)
- [Service Workers in Extensions](https://developer.chrome.com/docs/extensions/mv3/service_workers/)

